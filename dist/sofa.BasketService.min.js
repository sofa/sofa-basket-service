/**
 * sofa-basket-service - v0.4.0 - 2015-03-26
 * http://www.sofa.io
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO).
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(a,b){"use strict";a.define("sofa.BasketService",function(c,d,e){function f(b){return b?b.map(function(b){delete b.$$hashKey;var c=a.Util.extend(new a.models.BasketItem,b);return c.product&&(c.product=a.Util.extend(new a.models.Product,c.product)),c}):b}var g={},h="basketService_",i=h+"items",j=h+"coupons",k=f(c.get(i))||[],l=f(c.get(j))||[],m=e&&cc.Util.isFunction(e.productIdentityFn)?e.productIdentityFn:function(a,b,c,d){var e=b&&b.variantID,f=d&&d.variantID,g=b&&b.optionID,h=d&&d.optionID;return a.id===c.id&&e===f&&g===h},n=d.get("shippingCost"),o=d.get("shippingTax"),p=d.get("freeShippingFrom");a.observable.mixin(g);var q=function(){c.set(i,k),c.set(j,l)};q(),g.addItem=function(b,c,d){if(b.isOutOfStock())throw new Error("product out of stock");if(!r(b,c,d))throw new Error("exceeds available stock");var e=g.find(s(b,d)),f=!a.Util.isUndefined(e);return f||(e=new a.models.BasketItem,k.push(e)),e.product=b,e.quantity=e.quantity+c,e.variant=d,b.hasInfiniteStock()||d?null!==d&&cc.Util.isObject(d)&&cc.Util.isNumeric(d.stock)&&(d.stock=d.stock-c):b.qty=b.qty-c,q(),g.emit("itemAdded",g,e),e},g.canBeIncreasedBy=function(a,b){return r(a.product,b,a.variant)};var r=function(a,b,c){return c&&cc.Util.isNumeric(c.stock)?c.stock-b>=0:a.hasInfiniteStock()||a.qty-b>=0};g.addCoupon=function(a){var b=cc.Util.find(l,function(b){return b.code===a.code});b||(l.push(a),q(),g.emit("couponAdded",g,a))},g.removeCoupon=function(a){var b=cc.Util.find(l,function(b){return b.code===a});cc.Util.Array.remove(l,b),q(),g.emit("couponRemoved",g,b)},g.getActiveCoupons=function(){return l},g.increaseOne=function(a){return g.increase(a,1)},g.increase=function(a,b){return g.addItem(a.product,b,a.variant)},g.exists=function(b,c){var d=g.find(s(b,c));return!a.Util.isUndefined(d)};var s=function(a,b){return function(c){return m(a,b,c.product,c.variant)}};return g.removeItem=function(b,c,d){var e=g.find(s(b,c));if(!e)throw new Error("Product id: "+b.id+" , variant: "+c+"  does not exist in the basket");if(d&&e.quantity<d)throw new Error("remove quantity is higher than existing quantity");return e.quantity=d?e.quantity-d:0,0===e.quantity&&a.Util.Array.remove(k,e),d||(d=e.quantity),b.hasInfiniteStock()||c?null!==c&&cc.Util.isObject(c)&&cc.Util.isNumeric(c.stock)&&(c.stock=c.stock+d):b.qty=b.qty+d,q(),g.emit("itemRemoved",g,e),e},g.decreaseOne=function(a){return g.decrease(a,1)},g.decrease=function(a,b){return g.removeItem(a.product,a.variant,b)},g.clear=function(){return k.length=0,l.length=0,q(),g.emit("cleared",g),g},g.clearCoupons=function(){return l.length=0,q(),g.emit("clearedCoupons",g),g},g.find=function(b){return a.Util.find(k,b)},g.getItems=function(){return k},g.isEmpty=function(){return 0===k.length},g.getSummary=function(c){var d=n||0,e=o,f=p,g=0,h=0,i=0,j=0,m=c&&c.paymentMethod&&a.Util.isNumber(c.paymentMethod.surcharge)?c.paymentMethod.surcharge:0,q=c&&c.paymentMethod&&a.Util.isNumber(c.paymentMethod.surcharge_percentage)?c.paymentMethod.surcharge_percentage:0,r=0,s=function(a,b,c){return parseFloat(a*b/(100+b)*100/100)*c};k.forEach(function(a){var b=parseInt(a.quantity,10),c=a.product,d=a.getSpecialPrice(),e=parseInt(c.taxPercent,10);g+=b,h+=d*b,i+=s(d,e,b)}),d=null!==f&&f!==b&&h>=f?0:d,c&&c.shippingMethod&&a.Util.isNumber(c.shippingMethod.price)&&(d=c.shippingMethod.price),r=h+j,q&&(m=r*(q/100)),r+=d+m,l.forEach(function(b){r-=parseFloat(b.amount),b.tax=a.Util.isNumeric(b.tax)?b.tax:19,i-=s(b.amount,b.tax,1)}),i+=s(d,e,1);var t={quantity:g,sum:a.Util.round(h,2),sumStr:h.toFixed(2),vat:a.Util.round(i,2),vatStr:i.toFixed(2),shipping:a.Util.round(d,2),shippingStr:d.toFixed(2),surcharge:a.Util.round(m,2),surchargeStr:m.toFixed(2),discount:a.Util.round(j,2),total:a.Util.round(r,2),totalStr:r.toFixed(2),shippingTax:e};return t},g})}(sofa);