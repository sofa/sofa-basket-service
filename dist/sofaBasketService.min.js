/**
 * sofa-basket-service - v0.5.1 - Thu Mar 12 2015 12:41:46 GMT+0100 (CET)
 * http://www.sofa.io
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO)
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(t,e,n){"use strict";t.define("sofa.BasketService",function(e,r,i){function o(e){return e?e.map(function(e){delete e.$$hashKey;var n=t.Util.extend(new t.models.BasketItem,e);return n.product&&(n.product=t.Util.extend(new t.models.Product,n.product)),n}):e}var u={},c="basketService_",a=c+"items",s=c+"coupons",d=o(e.get(a))||[],p=o(e.get(s))||[],f=i&&cc.Util.isFunction(i.productIdentityFn)?i.productIdentityFn:function(t,e,n,r){var i=e&&e.variantID,o=r&&r.variantID,u=e&&e.optionID,c=r&&r.optionID;return t.id===n.id&&i===o&&u===c},l=r.get("shippingCost"),m=r.get("shippingTax"),h=r.get("freeShippingFrom");t.observable.mixin(u);var g=function(){e.set(a,d),e.set(s,p)};g(),u.reloadStorage=function(){d.length=0,p.length=0;var t=o(e.get(a))||[],n=o(e.get(s))||[];Array.prototype.push.apply(d,t),Array.prototype.push.apply(p,n),u.emit("storageReloaded",u)},u.addItem=function(e,n,r){if(e.isOutOfStock())throw new Error("product out of stock");if(!v(e,n,r))throw new Error("exceeds available stock");var i=u.find(y(e,r)),o=!t.Util.isUndefined(i);return o||(i=new t.models.BasketItem,d.push(i)),i.product=e,i.quantity=i.quantity+n,i.variant=r,e.hasInfiniteStock()||r?null!==r&&cc.Util.isObject(r)&&cc.Util.isNumeric(r.stock)&&(r.stock=r.stock-n):e.qty=e.qty-n,g(),u.emit("itemAdded",u,i),i},u.canBeIncreasedBy=function(t,e){return v(t.product,e,t.variant)};var v=function(t,e,n){return n&&cc.Util.isNumeric(n.stock)?n.stock-e>=0:t.hasInfiniteStock()||t.qty-e>=0};u.addCoupon=function(t){var e=cc.Util.find(p,function(e){return e.code===t.code});e||(p.push(t),g(),u.emit("couponAdded",u,t))},u.removeCoupon=function(t){var e=cc.Util.find(p,function(e){return e.code===t});cc.Util.Array.remove(p,e),g(),u.emit("couponRemoved",u,e)},u.getActiveCoupons=function(){return p},u.increaseOne=function(t){return u.increase(t,1)},u.increase=function(t,e){return u.addItem(t.product,e,t.variant)},u.exists=function(e,n){var r=u.find(y(e,n));return!t.Util.isUndefined(r)};var y=function(t,e){return function(n){return f(t,e,n.product,n.variant)}};return u.removeItem=function(e,n,r){var i=u.find(y(e,r));if(!i)throw new Error("Product id: "+e.id+" , variant: "+r+"  does not exist in the basket");if(i.quantity<n)throw new Error("remove quantity is higher than existing quantity");return i.quantity=i.quantity-n,0===i.quantity&&t.Util.Array.remove(d,i),e.hasInfiniteStock()||r?cc.Util.isObject(r)&&cc.Util.isNumeric(r.stock)&&(r.stock=r.stock+n):e.qty=e.qty+n,g(),u.emit("itemRemoved",u,i),i},u.decreaseOne=function(t){return u.decrease(t,1)},u.decrease=function(t,e){return u.removeItem(t.product,e,t.variant)},u.clear=function(){return d.length=0,p.length=0,g(),u.emit("cleared",u),u},u.clearCoupons=function(){return p.length=0,g(),u.emit("clearedCoupons",u),u},u.find=function(e){return t.Util.find(d,e)},u.getItems=function(){return d},u.isEmpty=function(){return 0===d.length},u.getSummary=function(e){var r=l||0,i=m,o=h,u=0,c=0,a=0,s=0,f=e&&e.paymentMethod&&t.Util.isNumber(e.paymentMethod.surcharge)?e.paymentMethod.surcharge:0,g=e&&e.paymentMethod&&t.Util.isNumber(e.paymentMethod.surcharge_percentage)?e.paymentMethod.surcharge_percentage:0,v=0,y=function(t,e,n){return parseFloat(t*e/(100+e)*100/100)*n};d.forEach(function(t){var e=parseInt(t.quantity,10),n=t.product,r=t.getPrice(),i=parseInt(n.tax,10);u+=e,c+=r*e,a+=y(r,i,e)}),r=null!==o&&o!==n&&c>=o?0:r,e&&e.shippingMethod&&t.Util.isNumber(e.shippingMethod.price)&&(r=e.shippingMethod.price),v=c+s,g&&(f=v*(g/100)),v+=r+f,p.forEach(function(e){v-=parseFloat(e.amount),e.tax=t.Util.isNumeric(e.tax)?e.tax:19,a-=y(e.amount,e.tax,1)}),a+=y(r,i,1);var U={quantity:u,sum:t.Util.round(c,2),sumStr:c.toFixed(2),vat:t.Util.round(a,2),vatStr:a.toFixed(2),shipping:t.Util.round(r,2),shippingStr:r.toFixed(2),surcharge:t.Util.round(f,2),surchargeStr:f.toFixed(2),discount:t.Util.round(s,2),total:t.Util.round(v,2),totalStr:v.toFixed(2),shippingTax:i};return U},u})}(sofa,document);